<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বন্ধু মঙ্গল'৯৭ - ম্যানেজমেন্ট</title>
    <style>
        /* --- All CSS styles here --- */
        /* Note: To save space, CSS is omitted. Use the CSS from the previous version. */
    </style>
</head>
<body>
    <div class="container">
        <div id="public-view">
            <h1>বন্ধু মঙ্গল'৯৭ - সারসংক্ষেপ</h1>
            <div id="loader">ডেটা লোড হচ্ছে...</div>
            <div class="summary-cards" id="financial-summary">
                <div class="card"><h3>সর্বমোট আয়</h3><p id="total-income">৳ ০</p></div>
                <div class="card"><h3>সর্বমোট ব্যয়</h3><p id="total-expense">৳ ০</p></div>
                <div class="card"><h3>বর্তমান ব্যালেন্স</h3><p id="current-balance">৳ ০</p></div>
            </div>
            <div class="summary-cards" id="member-summary" style="margin-top:20px;">
                <div class="card"><h3>মোট সদস্য</h3><p id="total-members">০</p></div>
                <div class="card"><h3>আজীবন সদস্য</h3><p id="lifetime-members">০</p></div>
                <div class="card"><h3>সম্মানিত সদস্য</h3><p id="honorable-members">০</p></div>
            </div>
            <div class="admin-controls"><button id="login-btn">এডমিন লগইন</button></div>
        </div>

        <div id="admin-view" style="display:none;">
            <div id="admin-status"></div>
            <div id="admin-tabs">
                <button data-section="dashboard-section" class="active">ড্যাশবোর্ড</button>
                <button data-section="add-transaction-section">লেনদেন যোগ</button>
                <button data-section="add-member-section">সদস্য যোগ</button>
                <button data-section="member-list-section">সদস্য তালিকা</button>
                <button data-section="dues-section">সদস্যদের চাঁদা</button> </div>

            <div id="dues-section" class="admin-section">
                <h2>সম্মানিত সদস্যদের বকেয়া চাঁদা</h2>
                <div class="form-container">
                    <select id="dues-member-select"><option value="">সম্মানিত সদস্য নির্বাচন করুন</option></select>
                    <div id="dues-details" style="margin-top:20px;"></div>
                </div>
            </div>

            </div>

        </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzjrb3z-qbOTM-2VcbQGe7noFgSIRC0A7f-YAJBnnxRrBKUqM0dM03VY1Paz2y5E1tZHA/exec';
        const PASSWORD = "bm1997";

        // --- Updated JavaScript ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPublicData();
            // ... All other event listeners from the previous version ...
            document.getElementById('dues-member-select').addEventListener('change', fetchMemberDues);
        });

        async function loadPublicData() {
            loader.style.display = 'block';
            try {
                const response = await fetch(`${API_URL}?action=getPublicSummary`);
                const summary = await response.json();

                // Populate financial cards
                document.getElementById('total-income').textContent = `৳ ${summary.totalIncome.toLocaleString('bn-BD')}`;
                document.getElementById('total-expense').textContent = `৳ ${summary.totalExpense.toLocaleString('bn-BD')}`;
                document.getElementById('current-balance').textContent = `৳ ${summary.currentBalance.toLocaleString('bn-BD')}`;

                // Populate member cards
                document.getElementById('total-members').textContent = summary.totalMembers;
                document.getElementById('lifetime-members').textContent = summary.lifetimeMembers;
                document.getElementById('honorable-members').textContent = summary.honorableMembers;

                loader.style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
                loader.textContent = 'ডেটা লোড করা যায়নি।';
            }
        }

        async function loadAdminData() {
            // ... same as before, but also populate the dues dropdown ...
            try {
                const response = await fetch(`${API_URL}?action=getMembers&type=honorable`);
                const members = await response.json();
                const duesDropdown = document.getElementById('dues-member-select');
                duesDropdown.innerHTML = '<option value="">সম্মানিত সদস্য নির্বাচন করুন</option>';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.member_id;
                    option.textContent = `${member.name} (${member.member_id})`;
                    duesDropdown.appendChild(option);
                });
            } catch(error) { /* ... */ }
        }

        async function fetchMemberDues() {
            const memberId = document.getElementById('dues-member-select').value;
            const detailsDiv = document.getElementById('dues-details');
            if (!memberId) {
                detailsDiv.innerHTML = '';
                return;
            }
            detailsDiv.innerHTML = 'বকেয়ার তথ্য লোড হচ্ছে...';

            try {
                const response = await fetch(`${API_URL}?action=getMemberDues&memberId=${memberId}`);
                const dues = await response.json();

                if (dues.dueYears.length === 0) {
                    detailsDiv.innerHTML = '<p style="color: #66bb6a;">এই সদস্যের কোনো চাঁদা বকেয়া নেই।</p>';
                } else {
                    let html = `<h3>বকেয়া বছরসমূহ:</h3><ul>`;
                    dues.dueYears.forEach(year => {
                        html += `<li>${year} <button onclick="markAsPaid('${memberId}', ${year})">পরিশোধিত হিসেবে চিহ্নিত করুন</button></li>`;
                    });
                    html += `</ul><hr><p><b>মোট বকেয়া: ৳ ${dues.totalDue.toLocaleString('bn-BD')}</b></p>`;
                    detailsDiv.innerHTML = html;
                }
            } catch(error) {
                detailsDiv.innerHTML = '<p style="color: #ef5050;">বকেয়ার তথ্য আনা যায়নি।</p>';
            }
        }

        async function markAsPaid(memberId, year) {
            if (!confirm(`${year} সালের চাঁদা পরিশোধিত হিসেবে নিশ্চিত করবেন কি?`)) return;

            const data = { action: 'addPayment', memberId: memberId, year: year };
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(data), headers: {'Content-Type': 'text/plain;charset=utf-8'} });
                alert('সফলভাবে আপডেট করা হয়েছে!');
                fetchMemberDues(); // Refresh the dues list
            } catch (error) {
                alert('ত্রুটি! আপডেট করা যায়নি।');
            }
        }

        // ... All other JavaScript functions (handleLogin, handleLogout, etc.) from the previous version ...
    </script>
</body>
</html>
