<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বন্ধু মঙ্গল'৯৭ - ম্যানেজমেন্ট</title>
    <style>
        body { font-family: 'Hind Siliguri', Arial, sans-serif; background-color: #1a2a25; color: #eaf0ed; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background-color: #243b34; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        h1, h2, h3 { text-align: center; color: #81c784; border-bottom: 2px solid #81c784; padding-bottom: 10px; margin-bottom: 20px; }
        button, select, input, textarea { padding: 12px; font-size: 1em; border-radius: 5px; border: 1px solid #4a6b5f; background-color: #1a2a25; color: #eaf0ed; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #81c784; color: #1a2a25; font-weight: bold; cursor: pointer; border: none; }
        .admin-section { display: none; }
        .form-container { background: #2f5247; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .form-container input, .form-container select, .form-container textarea { width: 100%; }
        #transaction-form-message, #member-form-message { text-align: center; font-weight: bold; margin-top: 15px; height: 20px; }
        .summary-cards { display: flex; justify-content: space-around; gap: 20px; flex-wrap: wrap; }
        .card { background-color: #2f5247; padding: 20px; border-radius: 8px; text-align: center; flex-grow: 1; min-width: 150px; }
        .card h3 { margin: 0 0 10px 0; color: #a5d6a7; border-bottom: none; font-size: 1em; }
        .card p { margin: 0; font-size: 1.6em; font-weight: bold; }
        #total-income, .amount-income { color: #66bb6a; } #total-expense, .amount-expense { color: #ef5050; } #current-balance { color: #4db6ac; }
        #loader { text-align: center; font-size: 1.2em; padding: 40px; }
        .admin-controls { text-align: center; margin: 30px 0; }
        #admin-status { text-align: center; margin-bottom: 20px; color: #4db6ac; font-weight: bold; display: none; }
        #admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #admin-tabs button { background-color: #2f5247; color: #a5d6a7; }
        #admin-tabs button.active { background-color: #81c784; color: #1a2a25; }
        .data-table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #4a6b5f; }
        .data-table th { color: #a5d6a7; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #243b34; padding: 30px; border-radius: 10px; text-align: center; }
        .modal-content input { width: 250px; }
        #error-message { color: #ef5050; height: 20px; }
        #dues-details ul { list-style: none; padding: 0; }
        #dues-details li { background-color: #1a2a25; padding: 10px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <div id="public-view">
            <h1>বন্ধু মঙ্গল'৯৭ - সারসংক্ষেপ</h1>
            <div id="loader">ডেটা লোড হচ্ছে...</div>
            <div class="summary-cards" id="financial-summary">
                <div class="card"><h3>সর্বমোট আয়</h3><p id="total-income">৳ ০</p></div>
                <div class="card"><h3>সর্বমোট ব্যয়</h3><p id="total-expense">৳ ০</p></div>
                <div class="card"><h3>বর্তমান ব্যালেন্স</h3><p id="current-balance">৳ ০</p></div>
            </div>
            <div class="summary-cards" id="member-summary" style="margin-top:20px;">
                <div class="card"><h3>মোট সদস্য</h3><p id="total-members">০</p></div>
                <div class="card"><h3>আজীবন সদস্য</h3><p id="lifetime-members">০</p></div>
                <div class="card"><h3>সম্মানিত সদস্য</h3><p id="honorable-members">০</p></div>
            </div>
            <div class="admin-controls"><button id="login-btn">অ্যাডমিন লগইন</button></div>
        </div>
        <div id="admin-view" style="display:none;">
            <div id="admin-status"></div>
            <div id="admin-tabs">
                <button data-section="dashboard-section" class="active">ড্যাশবোর্ড</button>
                <button data-section="dues-section">সদস্যদের চাঁদা</button>
                <button data-section="add-transaction-section">লেনদেন যোগ</button>
                <button data-section="add-member-section">সদস্য যোগ</button>
                <button data-section="member-list-section">সদস্য তালিকা</button>
            </div>
            <div id="dashboard-section" class="admin-section"></div>
            <div id="dues-section" class="admin-section">
                <h2>সম্মানিত সদস্যদের বকেয়া চাঁদা</h2>
                <div class="form-container">
                    <select id="dues-member-select"><option value="">সম্মানিত সদস্য নির্বাচন করুন</option></select>
                    <div id="dues-details" style="margin-top:20px;"></div>
                </div>
            </div>
            <div id="add-transaction-section" class="admin-section"><h2>...</h2></div>
            <div id="add-member-section" class="admin-section"><h2>...</h2></div>
            <div id="member-list-section" class="admin-section">
                <h2>সকল সদস্যদের তালিকা</h2>
                <div class="data-table-container">
                    <table class="data-table"><thead><tr><th>সদস্য আইডি</th><th>নাম</th><th>সদস্য ধরন</th><th>ফোন নাম্বার</th></tr></thead><tbody id="member-list-body"></tbody></table>
                </div>
            </div>
            <div class="admin-controls"><button id="logout-btn" style="background-color: #ef5050;">লগ-আউট</button></div>
        </div>
    </div>
    <div id="login-modal" class="modal-bg"><div class="modal-content">
        <h3>অ্যাডমিন লগইন</h3><input type="password" id="password" placeholder="পাসওয়ার্ড দিন"><br>
        <button id="modal-login-btn">প্রবেশ করুন</button><button id="modal-close-btn" style="background-color: #aaa; margin-left: 10px;">বন্ধ করুন</button>
        <p id="error-message"></p>
    </div></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw5mdYSJxvAmfXd9fmEtaASreTEvmo2LTFuTuSOluGPS0azq-xu_VVYDEwv8jz5p87nlg/exec';
        const PASSWORD = "bm1997";

        const $ = (selector) => document.getElementById(selector);

        document.addEventListener('DOMContentLoaded', () => {
            loadPublicData();
            $('login-btn').addEventListener('click', () => $('login-modal').style.display = 'flex');
            $('logout-btn').addEventListener('click', handleLogout);
            $('modal-login-btn').addEventListener('click', handleLogin);
            $('modal-close-btn').addEventListener('click', () => $('login-modal').style.display = 'none');

            // Add forms and tabs event listeners later to avoid error if elements don't exist
            const transactionForm = $('transaction-form');
            if (transactionForm) transactionForm.addEventListener('submit', handleTransactionSubmit);

            const memberForm = $('member-form');
            if (memberForm) memberForm.addEventListener('submit', handleMemberSubmit);

            const duesSelect = $('dues-member-select');
            if (duesSelect) duesSelect.addEventListener('change', fetchMemberDues);

            document.querySelectorAll('#admin-tabs button').forEach(button => {
                button.addEventListener('click', () => showSection(button.dataset.section));
            });
        });

        function handleLogin() {
            if ($('password').value === PASSWORD) {
                $('public-view').style.display = 'none';
                $('admin-view').style.display = 'block';
                $('admin-status').textContent = "আপনি অ্যাডমিন হিসেবে লগইন করেছেন।";
                $('admin-status').style.display = 'block';
                $('login-modal').style.display = 'none';
                $('password').value = '';
                $('dashboard-section').innerHTML = $('public-view').innerHTML; // Copy public view to admin dashboard
                loadAdminData();
                showSection('dashboard-section');
            } else {
                $('error-message').textContent = 'ভুল পাসওয়ার্ড!';
            }
        }

        function handleLogout() {
            $('public-view').style.display = 'block';
            $('admin-view').style.display = 'none';
            $('admin-status').style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(sec => sec.style.display = 'none');
            $(sectionId).style.display = 'block';
            document.querySelectorAll('#admin-tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#admin-tabs button[data-section='${sectionId}']`).classList.add('active');
        }

        async function loadPublicData() {
            const loader = $('loader');
            loader.textContent = 'ডেটা লোড হচ্ছে...';
            loader.style.display = 'block';
            try {
                const res = await fetch(`${API_URL}?action=getPublicSummary`);
                if (!res.ok) throw new Error('Network error');
                const summary = await res.json();
                if (summary.error) throw new Error(summary.error);

                $('total-income').textContent = `৳ ${summary.totalIncome.toLocaleString('bn-BD')}`;
                $('total-expense').textContent = `৳ ${summary.totalExpense.toLocaleString('bn-BD')}`;
                $('current-balance').textContent = `৳ ${summary.currentBalance.toLocaleString('bn-BD')}`;
                $('total-members').textContent = summary.totalMembers;
                $('lifetime-members').textContent = summary.lifetimeMembers;
                $('honorable-members').textContent = summary.honorableMembers;

                loader.style.display = 'none';
            } catch (err) {
                loader.textContent = 'ডেটা লোড করা যায়নি।';
                console.error(err);
            }
        }

        async function loadAdminData() {
            try {
                const res = await fetch(`${API_URL}?action=getMembers&type=all`);
                const allMembers = await res.json();

                const memberListBody = $('member-list-body');
                const duesDropdown = $('dues-member-select');

                memberListBody.innerHTML = '';
                duesDropdown.innerHTML = '<option value="">সম্মানিত সদস্য নির্বাচন করুন</option>';

                allMembers.forEach(member => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${member.member_id}</td><td>${member.name}</td><td>${member.member_type || ''}</td><td>${member.phone_number || ''}</td>`;
                    memberListBody.appendChild(row);

                    if (member.member_type === 'সম্মানিত') {
                        const option = document.createElement('option');
                        option.value = member.member_id;
                        option.textContent = `${member.name} (${member.member_id})`;
                        duesDropdown.appendChild(option);
                    }
                });
            } catch (err) { console.error(err); }
        }

        async function fetchMemberDues() {
            const memberId = $('dues-member-select').value;
            const detailsDiv = $('dues-details');
            if (!memberId) { detailsDiv.innerHTML = ''; return; }
            detailsDiv.innerHTML = 'বকেয়ার তথ্য লোড হচ্ছে...';

            try {
                const res = await fetch(`${API_URL}?action=getMemberDues&memberId=${memberId}`);
                const dues = await res.json();
                if (dues.error) throw new Error(dues.error);

                if (dues.dueYears.length === 0) {
                    detailsDiv.innerHTML = '<p style="color: #66bb6a;">এই সদস্যের কোনো চাঁদা বকেয়া নেই।</p>';
                } else {
                    let html = `<h3>বকেয়া বছরসমূহ:</h3><ul>`;
                    dues.dueYears.forEach(year => {
                        html += `<li><span>${year}</span> <button data-member-id="${memberId}" data-year="${year}" data-member-name="${$('dues-member-select').options[$('dues-member-select').selectedIndex].text}">পরিশোধিত করুন</button></li>`;
                    });
                    html += `</ul><hr><p><b>মোট বকেয়া: ৳ ${dues.totalDue.toLocaleString('bn-BD')}</b></p>`;
                    detailsDiv.innerHTML = html;

                    // Add event listeners to the new buttons
                    detailsDiv.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const { memberId, year, memberName } = e.target.dataset;
                            markAsPaid(memberId, year, memberName);
                        });
                    });
                }
            } catch(err) { 
                detailsDiv.innerHTML = `<p style="color: #ef5050;">বকেয়ার তথ্য আনা যায়নি। (${err.message})</p>`;
            }
        }

        async function markAsPaid(memberId, year, memberName) {
            if (!confirm(`${memberName} এর ${year} সালের চাঁদা পরিশোধিত হিসেবে নিশ্চিত করবেন কি?`)) return;
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addPayment', memberId, year, memberName }), headers: {'Content-Type': 'text/plain;charset=utf-8'} });
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
                await fetchMemberDues(); // Refresh list
                await loadPublicData(); // Refresh public data as a payment is a transaction
            } catch (err) { alert('ত্রুটি! আপডেট করা যায়নি।'); }
        }
        // The handleTransactionSubmit and handleMemberSubmit functions are complex and will be added back once this base is confirmed working.
        function handleTransactionSubmit(event) { event.preventDefault(); alert("Feature coming soon!");}
        function handleMemberSubmit(event) { event.preventDefault(); alert("Feature coming soon!");}
    </script>
</body>
</html>
